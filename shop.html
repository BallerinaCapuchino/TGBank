<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>MT Shop ‚Äî Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0e1118;
            --panel: #111827;
            --panel-2: #0b1220;
            --text: #ecf2ff;
            --muted: #97a3b6;
            --accent: #3b82f6;
            --accent-2: #60a5fa;
            --good: #22c55e;
            --danger: #ef4444;
            --amber: #f5a524;
            --stroke: rgba(255,255,255,.06);
            --radius: 18px;
            --shadow: 0 24px 60px rgba(0,0,0,.45), 0 8px 20px rgba(0,0,0,.35);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
            color: var(--text);
            background: radial-gradient(80vw 80vh at 10% -10%, #1a2030 0%, transparent 60%),
                        radial-gradient(80vw 80vh at 110% 10%, #0d1424 0%, transparent 60%),
                        var(--bg);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .hidden { display: none !important; }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: linear-gradient(180deg, #111827, #0c1424);
            border: 1px solid var(--stroke);
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow);
        }

        .auth-logo {
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            text-align: center;
            color: var(--muted);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s ease;
            font-size: 14px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(180deg, var(--accent), var(--accent-2));
            color: #061022;
            box-shadow: 0 8px 20px rgba(59, 130, 246, .25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, .35);
        }

        .btn-secondary {
            background: var(--panel-2);
            color: var(--text);
            border: 1px solid var(--stroke);
        }

        .btn-secondary:hover {
            background: #151d2e;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .auth-switch {
            text-align: center;
            margin-top: 16px;
            color: var(--muted);
            font-size: 13px;
        }

        .auth-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, #111827, #0c1424);
            border: 1px solid var(--stroke);
            border-radius: 24px;
            padding: 16px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 0.3px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .balance-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            padding: 10px 16px;
            border-radius: 12px;
        }

        .balance-label {
            color: var(--muted);
            font-size: 13px;
        }

        .balance-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--good);
        }

        .user-badge {
            padding: 8px 12px;
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            border-radius: 12px;
            font-size: 13px;
            color: var(--muted);
        }

        .user-badge strong {
            color: var(--text);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--panel);
            padding: 8px;
            border-radius: 16px;
            border: 1px solid var(--stroke);
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--muted);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all .2s ease;
        }

        .tab.active {
            background: var(--accent);
            color: #061022;
        }

        /* Search & Filters */
        .filters {
            background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)), var(--panel);
            border: 1px solid var(--stroke);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        .category-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 6px 12px;
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all .2s ease;
        }

        .tag:hover, .tag.active {
            background: var(--accent);
            color: #061022;
            border-color: var(--accent);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .product-card {
            background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)), var(--panel);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform .2s ease;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 28px 64px rgba(0,0,0,.5);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #1a2332, #0f1621);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            border-bottom: 1px solid var(--stroke);
        }

        .product-info {
            padding: 16px;
        }

        .product-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .product-description {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .product-price {
            font-size: 20px;
            font-weight: 800;
            color: var(--good);
        }

        .stock-badge {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(34, 197, 94, .15);
            color: var(--good);
        }

        /* Store Management */
        .store-card {
            background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)), var(--panel);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .store-title {
            font-size: 24px;
            font-weight: 800;
        }

        .store-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            padding: 16px;
            border-radius: 12px;
        }

        .stat-label {
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
        }

        /* Admin Panel */
        .admin-section {
            background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)), var(--panel);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .admin-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 16px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--stroke);
        }

        .table th {
            color: var(--muted);
            font-weight: 600;
            font-size: 13px;
        }

        /* Cart */
        .cart-float {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(180deg, var(--accent), var(--accent-2));
            color: #061022;
            padding: 16px 20px;
            border-radius: 20px;
            box-shadow: 0 12px 32px rgba(59, 130, 246, .4);
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all .2s ease;
            z-index: 100;
        }

        .cart-float:hover {
            transform: scale(1.05);
            box-shadow: 0 16px 40px rgba(59, 130, 246, .5);
        }

        .cart-badge {
            background: #061022;
            color: var(--accent);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 800;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal {
            background: linear-gradient(180deg, #111827, #0c1424);
            border: 1px solid var(--stroke);
            border-radius: 24px;
            box-shadow: var(--shadow);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stroke);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 800;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all .2s ease;
        }

        .close-btn:hover {
            background: var(--panel-2);
            color: var(--text);
        }

        .modal-body {
            padding: 24px;
        }

        .cart-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            border-radius: 14px;
            margin-bottom: 12px;
        }

        .cart-item-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1a2332, #0f1621);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .cart-item-price {
            color: var(--muted);
            font-size: 13px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--panel);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all .2s ease;
        }

        .qty-btn:hover {
            background: var(--accent);
            color: #061022;
        }

        .qty-value {
            width: 40px;
            text-align: center;
            font-weight: 700;
        }

        .cart-total {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(180deg, rgba(59, 130, 246, .1), rgba(59, 130, 246, .05));
            border: 1px solid rgba(59, 130, 246, .2);
            border-radius: 14px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .total-label {
            color: var(--muted);
        }

        .total-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--good);
        }

        /* Swipe Confirm */
        .swipe-confirm {
            margin-top: 20px;
        }

        .swipe-label {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .swipe-track {
            position: relative;
            height: 60px;
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            border-radius: 999px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swipe-hint {
            pointer-events: none;
            font-size: 14px;
            color: var(--muted);
            transition: opacity .2s ease;
        }

        .swipe-knob {
            position: absolute;
            left: 4px;
            top: 4px;
            width: 52px;
            height: 52px;
            background: linear-gradient(180deg, var(--accent), var(--accent-2));
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: #061022;
            cursor: grab;
            touch-action: none;
            box-shadow: 0 8px 20px rgba(59, 130, 246, .35);
            transform: translateX(0);
        }

        .swipe-knob:active {
            cursor: grabbing;
        }

        .swipe-knob.success {
            background: var(--good);
        }

        /* Success Animation */
        .success-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .success-circle {
            stroke: var(--good);
            stroke-width: 6;
            fill: none;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            animation: drawCircle .6s ease forwards;
        }

        .success-check {
            stroke: var(--good);
            stroke-width: 6;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 70;
            stroke-dashoffset: 70;
            animation: drawCheck .5s ease .2s forwards;
        }

        @keyframes drawCircle {
            to { stroke-dashoffset: 0; }
        }

        @keyframes drawCheck {
            to { stroke-dashoffset: 0; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: .5;
        }

        /* Notification System */
        .notification-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .notification {
            background: linear-gradient(180deg, #111827, #0c1424);
            border: 1px solid var(--stroke);
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn .3s ease;
            min-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid var(--good);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.info {
            border-left: 4px solid var(--accent);
        }

        .notification-icon {
            font-size: 24px;
            line-height: 1;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-message {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all .2s ease;
        }

        .notification-close:hover {
            background: var(--panel-2);
            color: var(--text);
        }

        .product-store-name {
            font-size: 11px;
            color: var(--accent);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .store-info-box {
            background: linear-gradient(180deg, rgba(59, 130, 246, .1), rgba(59, 130, 246, .05));
            border: 1px solid rgba(59, 130, 246, .2);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .store-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .store-info-row:last-child {
            margin-bottom: 0;
        }

        .store-info-label {
            color: var(--muted);
            font-size: 13px;
        }

        .store-info-value {
            font-weight: 700;
            font-size: 14px;
        }

        /* iOS-style Exit Indicator */
        .ios-exit-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 5px;
            background: rgba(255, 255, 255, .3);
            border-radius: 0 0 8px 8px;
            z-index: 400;
            cursor: pointer;
            transition: all .3s ease;
        }

        .ios-exit-indicator:hover {
            height: 8px;
            background: rgba(255, 255, 255, .5);
        }

        .ios-exit-indicator.dragging {
            height: 30px;
            background: linear-gradient(180deg, rgba(239, 68, 68, .7), rgba(239, 68, 68, .4));
        }

        @media (max-width: 768px) {
            .notification-container {
                right: 16px;
                left: 16px;
                max-width: none;
            }

            .notification {
                min-width: 0;
            }
            .products-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
            }

            .cart-float {
                bottom: 16px;
                right: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- iOS-style Exit Indicator (shown only in main app) -->
    <div class="ios-exit-indicator hidden" id="exitIndicator"></div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <div style="text-align: center; margin-bottom: 16px;">
                <button class="btn btn-secondary btn-small" onclick="window.location.href='index.html'" style="width: auto;">‚Üê –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª</button>
            </div>
            <div class="auth-logo">üõí MT Shop</div>
            <div class="auth-subtitle">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞</div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
                <button class="btn btn-secondary" style="margin-top: 12px;" onclick="loginWithBank()">üè¶ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±–∞–Ω–∫</button>
                <div class="auth-switch">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="auth-link" onclick="showRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
                </div>
            </div>

            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="regUsername" class="form-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="regPassword" class="form-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <div class="auth-switch">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="auth-link" onclick="showLogin()">–í–æ–π—Ç–∏</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <!-- Header -->
        <div class="header">
            <div class="logo">üõí MT Shop</div>
            <div class="header-actions">
                <div class="user-badge" id="userBadge"></div>
                <div class="balance-info">
                    <div class="balance-label">–ë–∞–ª–∞–Ω—Å</div>
                    <div class="balance-value" id="balance">M$ 0</div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="openChangePassword()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button class="btn btn-secondary btn-small" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="catalog" onclick="switchTab('catalog')">–ö–∞—Ç–∞–ª–æ–≥</button>
            <button class="tab" data-tab="mystore" onclick="switchTab('mystore')" id="tabMyStore">–ú–æ–π –º–∞–≥–∞–∑–∏–Ω</button>
            <button class="tab" data-tab="admin" onclick="switchTab('admin')" id="tabAdmin" class="hidden">–ê–¥–º–∏–Ω</button>
        </div>

        <!-- Catalog Tab -->
        <div id="catalogTab" class="tab-content">
            <div class="filters">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
                    <button class="btn btn-secondary btn-small" onclick="searchProducts()">üîç –ü–æ–∏—Å–∫</button>
                </div>
                <div class="category-tags" id="categories">
                    <div class="tag active" data-category="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>
                    <div class="tag" data-category="electronics">–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</div>
                    <div class="tag" data-category="clothing">–û–¥–µ–∂–¥–∞</div>
                    <div class="tag" data-category="home">–î–æ–º</div>
                    <div class="tag" data-category="sport">–°–ø–æ—Ä—Ç</div>
                </div>
            </div>
            <div class="products-grid" id="productsGrid"></div>
        </div>

        <!-- My Store Tab -->
        <div id="mystoreTab" class="tab-content hidden">
            <div id="noStoreContent">
                <div class="store-card">
                    <div class="empty-state">
                        <div class="empty-icon">üè™</div>
                        <h2>–£ –≤–∞—Å –Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–∞</h2>
                        <p style="color: var(--muted); margin: 16px 0;">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –º–∞–≥–∞–∑–∏–Ω –∏ –Ω–∞—á–Ω–∏—Ç–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å</p>
                        <button class="btn btn-primary" onclick="buyStore()">–ö—É–ø–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω –∑–∞ 550 000 M$</button>
                    </div>
                </div>
            </div>

            <div id="hasStoreContent" class="hidden">
                <div class="store-card">
                    <div class="store-header">
                        <div class="store-title" id="storeName">–ú–æ–π –º–∞–≥–∞–∑–∏–Ω</div>
                        <button class="btn btn-primary btn-small" onclick="showAddProductModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                    </div>
                    
                    <div class="store-stats">
                        <div class="stat-box">
                            <div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤</div>
                            <div class="stat-value" id="storeProductCount">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">–ü—Ä–æ–¥–∞–Ω–æ</div>
                            <div class="stat-value" id="storeSales">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">–ü—Ä–∏–±—ã–ª—å</div>
                            <div class="stat-value" style="color: var(--good);" id="storeRevenue">M$ 0</div>
                        </div>
                    </div>

                    <div class="products-grid" id="myProducts"></div>
                </div>

                <!-- Pending withdrawals notification -->
                <div id="withdrawalNotifications"></div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content hidden">
            <div class="admin-section">
                <div class="admin-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</div>
                <div class="store-stats">
                    <div class="stat-box">
                        <div class="stat-label">–í—Å–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤</div>
                        <div class="stat-value" id="adminStoresCount">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
                        <div class="stat-value" id="adminProductsCount">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div class="stat-value" id="adminUsersCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Withdrawal requests -->
            <div class="admin-section" id="adminWithdrawalsSection">
                <div class="admin-title">üí∞ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>
                <div id="adminWithdrawals"></div>
            </div>

            <div class="admin-section">
                <div class="admin-title">üè™ –ú–∞–≥–∞–∑–∏–Ω—ã</div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–¢–æ–≤–∞—Ä–æ–≤</th>
                            <th>–ü—Ä–æ–¥–∞–Ω–æ</th>
                            <th>–ü—Ä–∏–±—ã–ª—å</th>
                        </tr>
                    </thead>
                    <tbody id="adminStoresTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Cart Float Button -->
    <div class="cart-float hidden" id="cartFloat" onclick="openCart()">
        <span>üõí –ö–æ—Ä–∑–∏–Ω–∞</span>
        <div class="cart-badge" id="cartBadge">0</div>
    </div>

    <!-- Cart Modal -->
    <div class="modal-backdrop" id="cartModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
                <button class="close-btn" onclick="closeCart()">√ó</button>
            </div>
            <div class="modal-body" id="cartBody"></div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal-backdrop" id="addProductModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div>
                <button class="close-btn" onclick="closeAddProductModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="productTitle" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                </div>
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" id="productDesc" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                </div>
                <div class="form-group">
                    <label class="form-label">–¶–µ–Ω–∞ (M$)</label>
                    <input type="number" id="productPrice" class="form-input" placeholder="1000">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="productStock" class="form-input" placeholder="10">
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label>
                    <input type="text" id="productIcon" class="form-input" placeholder="üì¶" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="productCategory" class="form-input">
                        <option value="electronics">–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                        <option value="clothing">–û–¥–µ–∂–¥–∞</option>
                        <option value="home">–î–æ–º</option>
                        <option value="sport">–°–ø–æ—Ä—Ç</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // Telegram Web App initialization
        const tg = window.Telegram?.WebApp;
        let tgUser = null;
        
        if (tg) {
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation();
            
            // Get Telegram user
            const initData = tg.initDataUnsafe;
            if (initData?.user) {
                tgUser = initData.user;
                localStorage.setItem('tg_user', JSON.stringify(tgUser));
            } else {
                const stored = localStorage.getItem('tg_user');
                if (stored) tgUser = JSON.parse(stored);
            }
            
            // Setup back button
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                window.location.href = 'index.html';
            });
            
            // Apply theme
            if (tg.themeParams.bg_color) {
                document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color);
                document.documentElement.style.setProperty('--panel', tg.themeParams.secondary_bg_color || '#111827');
                document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#ecf2ff');
            }
        }

        const STORE_PRICE = 550000;
        const INITIAL_BALANCE = 0;
        const LISTING_FEE_PERCENT = 10;
        const DAILY_INCOME = 5000;
        const DAILY_TAX = 500;
        const WITHDRAWAL_DELAY = 5 * 60 * 1000; // 5 minutes in milliseconds
        const LS_USERS = 'mtshop_users';
        const LS_SESSION = 'mtshop_session';
        const LS_PRODUCTS = 'mtshop_products';
        const LS_STORES = 'mtshop_stores';
        const LS_WITHDRAWALS = 'mtshop_withdrawals';

        let currentUser = null;
        let cart = [];
        let currentCategory = 'all';

        // Withdrawal requests storage
        function getWithdrawals() {
            return JSON.parse(localStorage.getItem(LS_WITHDRAWALS) || '[]');
        }

        function saveWithdrawals(withdrawals) {
            localStorage.setItem(LS_WITHDRAWALS, JSON.stringify(withdrawals));
        }

        // Get bank balance from bank.html localStorage
        function getBankBalance() {
            try {
                const users = JSON.parse(localStorage.getItem('msbank_users_v11') || '[]');
                const user = users.find(u => u.username === currentUser.username);
                return user ? user.balance : 0;
            } catch (e) {
                return 0;
            }
        }

        // Update bank balance
        function updateBankBalance(amount) {
            try {
                const users = JSON.parse(localStorage.getItem('msbank_users_v11') || '[]');
                const userIndex = users.findIndex(u => u.username === currentUser.username);
                if (userIndex !== -1) {
                    users[userIndex].balance = Math.round((users[userIndex].balance + amount) * 100) / 100;
                    localStorage.setItem('msbank_users_v11', JSON.stringify(users));
                    return true;
                }
            } catch (e) {
                return false;
            }
            return false;
        }

        const fmt = n => new Intl.NumberFormat('ru-RU').format(n);

        // Notification System
        function showNotification(message, type = 'info', title = '') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '‚úì',
                error: '‚úï',
                info: '‚Ñπ'
            };
            
            const titles = {
                success: title || '–£—Å–ø–µ—à–Ω–æ',
                error: title || '–û—à–∏–±–∫–∞',
                info: title || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">${icons[type]}</div>
                <div class="notification-content">
                    <div class="notification-title">${titles[type]}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Storage helpers
        function getUsers() {
            return JSON.parse(localStorage.getItem(LS_USERS) || '[]');
        }

        function saveUsers(users) {
            localStorage.setItem(LS_USERS, JSON.stringify(users));
        }

        function getProducts() {
            return JSON.parse(localStorage.getItem(LS_PRODUCTS) || '[]');
        }

        function saveProducts(products) {
            localStorage.setItem(LS_PRODUCTS, JSON.stringify(products));
        }

        function getStores() {
            return JSON.parse(localStorage.getItem(LS_STORES) || '[]');
        }

        function saveStores(stores) {
            localStorage.setItem(LS_STORES, JSON.stringify(stores));
        }

        // Init seed data
        function seedData() {
            let users = getUsers();
            if (users.length === 0) {
                users = [
                    { id: 1, username: 'max', password: '12345', balance: 1000000, role: 'admin' }
                ];
                saveUsers(users);
            }

            // Create MT Shop for max if doesn't exist
            let stores = getStores();
            const mtShop = stores.find(s => s.ownerId === 1);
            if (!mtShop) {
                stores.push({
                    id: 1,
                    ownerId: 1,
                    name: 'MT Shop',
                    soldCount: 0,
                    revenue: 0,
                    withdrawalBalance: 0
                });
                saveStores(stores);
            }

            let products = getProducts();
            if (products.length === 0) {
                products = [
                    { id: 1, storeId: 1, title: '–°–º–∞—Ä—Ç—Ñ–æ–Ω Premium', description: '–§–ª–∞–≥–º–∞–Ω—Å–∫–∏–π —Å–º–∞—Ä—Ç—Ñ–æ–Ω', price: 2500, stock: 5, category: 'electronics', icon: 'üì±', soldCount: 0 },
                    { id: 2, storeId: 1, title: '–ù–æ—É—Ç–±—É–∫ Pro', description: '–ú–æ—â–Ω—ã–π –Ω–æ—É—Ç–±—É–∫', price: 5000, stock: 3, category: 'electronics', icon: 'üíª', soldCount: 0 },
                    { id: 3, storeId: 1, title: '–ù–∞—É—à–Ω–∏–∫–∏ Wireless', description: '–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏', price: 800, stock: 10, category: 'electronics', icon: 'üéß', soldCount: 0 },
                    { id: 4, storeId: 1, title: '–§—É—Ç–±–æ–ª–∫–∞ Classic', description: '–£–¥–æ–±–Ω–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞', price: 150, stock: 20, category: 'clothing', icon: 'üëï', soldCount: 0 },
                    { id: 5, storeId: 1, title: '–î–∂–∏–Ω—Å—ã Casual', description: '–°—Ç–∏–ª—å–Ω—ã–µ –¥–∂–∏–Ω—Å—ã', price: 350, stock: 15, category: 'clothing', icon: 'üëñ', soldCount: 0 },
                    { id: 6, storeId: 1, title: '–ö—Ä–æ—Å—Å–æ–≤–∫–∏ Sport', description: '–õ–µ–≥–∫–∏–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏', price: 600, stock: 8, category: 'sport', icon: 'üëü', soldCount: 0 },
                    { id: 7, storeId: 1, title: '–õ–∞–º–ø–∞ –Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è', description: 'LED –ª–∞–º–ø–∞', price: 200, stock: 12, category: 'home', icon: 'üí°', soldCount: 0 },
                    { id: 8, storeId: 1, title: '–ß–∞–π–Ω–∏–∫ Smart', description: '–£–º–Ω—ã–π —á–∞–π–Ω–∏–∫', price: 400, stock: 7, category: 'home', icon: '‚òï', soldCount: 0 },
                ];
                saveProducts(products);
            }
        }

        // Auth
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;

            if (!username || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            let users = getUsers();
            if (users.find(u => u.username === username)) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
                return;
            }

            const newUser = {
                id: Date.now(),
                username,
                password,
                balance: INITIAL_BALANCE,
                role: 'user'
            };

            users.push(newUser);
            saveUsers(users);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π—Ç–∏ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            currentUser = newUser;
            localStorage.setItem(LS_SESSION, JSON.stringify(newUser));
            showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}! –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å`, 'success');
            showMainApp();
        }

        function login() {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const users = getUsers();
            const userExists = users.find(u => u.username === username);
            
            if (!userExists) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            const user = users.find(u => u.username === username && u.password === password);
            if (!user) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            currentUser = user;
            localStorage.setItem(LS_SESSION, JSON.stringify(user));
            showMainApp();
        }
        
        // Auto-login with Telegram user
        function tryTelegramAutoLogin() {
            if (!tgUser) return false;
            
            const username = tgUser.username || `tg_${tgUser.id}`;
            let users = getUsers();
            let user = users.find(u => u.username === username);
            
            if (!user) {
                // Auto-register Telegram user
                const isFirstUser = username === 'max';
                user = {
                    id: Date.now(),
                    username: username,
                    password: String(tgUser.id),
                    balance: isFirstUser ? 1000000 : INITIAL_BALANCE,
                    role: isFirstUser ? 'admin' : 'user',
                    telegramId: tgUser.id,
                    firstName: tgUser.first_name,
                    lastName: tgUser.last_name
                };
                users.push(user);
                saveUsers(users);
                showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${tgUser.first_name}!`, 'success');
            }
            
            currentUser = user;
            localStorage.setItem(LS_SESSION, JSON.stringify(user));
            showMainApp();
            return true;
        }

        // Login with bank account
        function loginWithBank() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            // Check bank users
            try {
                const bankUsers = JSON.parse(localStorage.getItem('msbank_users_v11') || '[]');
                const bankUser = bankUsers.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
                
                if (!bankUser || bankUser.deleted) {
                    showNotification('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–∞ –∏–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω', 'error');
                    return;
                }

                // Check if user exists in shop
                let shopUsers = getUsers();
                let shopUser = shopUsers.find(u => u.username.toLowerCase() === username.toLowerCase());

                if (!shopUser) {
                    // Create new shop user with bank data
                    shopUser = {
                        id: Date.now(),
                        username: bankUser.username,
                        password: bankUser.password,
                        balance: bankUser.balance,
                        role: bankUser.isAdmin ? 'admin' : 'user'
                    };
                    shopUsers.push(shopUser);
                    saveUsers(shopUsers);
                } else {
                    // Update existing user password and balance from bank
                    shopUser.password = bankUser.password;
                    shopUser.balance = bankUser.balance;
                    const userIndex = shopUsers.findIndex(u => u.id === shopUser.id);
                    shopUsers[userIndex] = shopUser;
                    saveUsers(shopUsers);
                }

                currentUser = shopUser;
                localStorage.setItem(LS_SESSION, JSON.stringify(shopUser));
                showNotification('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ –±–∞–Ω–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                showMainApp();
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ –±–∞–Ω–∫', 'error');
                console.error(e);
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem(LS_SESSION);
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('cartFloat').classList.add('hidden');
            document.getElementById('exitIndicator').classList.add('hidden');
        }

        // iOS-style exit indicator
        function initExitIndicator() {
            const indicator = document.getElementById('exitIndicator');
            if (!indicator) return;

            let startY = 0;
            let currentY = 0;
            let dragging = false;

            indicator.addEventListener('pointerdown', (e) => {
                dragging = true;
                startY = e.clientY;
                currentY = 0;
                indicator.classList.add('dragging');
                e.preventDefault();
            });

            document.addEventListener('pointermove', (e) => {
                if (!dragging) return;
                currentY = Math.max(0, e.clientY - startY);
                
                if (currentY > 100) {
                    dragging = false;
                    indicator.classList.remove('dragging');
                    logout();
                }
            });

            document.addEventListener('pointerup', () => {
                if (!dragging) return;
                dragging = false;
                indicator.classList.remove('dragging');
            });
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('cartFloat').classList.remove('hidden');
            document.getElementById('exitIndicator').classList.remove('hidden');
            updateUI();
            checkUserNotifications();
            switchTab('catalog');
            initExitIndicator();
            
            // Check for notifications every 10 seconds
            setInterval(checkUserNotifications, 10000);
        }

        function updateUI() {
            // Load balance from bank if available
            const bankBalance = getBankBalance();
            const displayBalance = bankBalance > 0 ? bankBalance : currentUser.balance;
            document.getElementById('balance').textContent = `M$ ${fmt(displayBalance)}`;
            document.getElementById('userBadge').innerHTML = `<strong>${currentUser.username}</strong> ¬∑ ${currentUser.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : currentUser.role === 'shop_owner' ? '–í–ª–∞–¥–µ–ª–µ—Ü –º–∞–≥–∞–∑–∏–Ω–∞' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`;
            
            // Show admin tab only to user "max"
            if (currentUser.username === 'max') {
                document.getElementById('tabAdmin').classList.remove('hidden');
            } else {
                document.getElementById('tabAdmin').classList.add('hidden');
            }
            
            if (currentUser.role === 'shop_owner' || currentUser.role === 'admin') {
                document.getElementById('tabMyStore').classList.remove('hidden');
            }
        }

        // Tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`${tab}Tab`).classList.remove('hidden');

            if (tab === 'catalog') renderProducts();
            if (tab === 'mystore') renderMyStore();
            if (tab === 'admin') renderAdmin();
        }

        // Products
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            let products = getProducts();
            const stores = getStores();
            
            let filtered = products.filter(p => {
                const matchCategory = currentCategory === 'all' || p.category === currentCategory;
                const matchSearch = !search || p.title.toLowerCase().includes(search) || p.description.toLowerCase().includes(search);
                return matchCategory && matchSearch && p.stock > 0;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üòî</div><div>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div></div>';
                return;
            }

            grid.innerHTML = filtered.map(p => {
                let storeName = '';
                if (p.storeId) {
                    const store = stores.find(s => s.id === p.storeId);
                    storeName = store ? `<div class="product-store-name">üè™ ${store.name}</div>` : '';
                }
                
                return `
                    <div class="product-card" onclick="addToCart(${p.id})">
                        <div class="product-image">${p.icon}</div>
                        <div class="product-info">
                            ${storeName}
                            <div class="product-title">${p.title}</div>
                            <div class="product-description">${p.description}</div>
                            <div class="product-footer">
                                <div class="product-price">M$ ${fmt(p.price)}</div>
                                <div class="stock-badge">–û—Å—Ç–∞–ª–æ—Å—å: ${p.stock}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', () => {
                document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                tag.classList.add('active');
                currentCategory = tag.dataset.category;
                renderProducts();
            });
        });

        function searchProducts() {
            renderProducts();
        }

        // Cart
        function addToCart(productId) {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existing = cart.find(item => item.id === productId);
            if (existing) {
                if (existing.qty < product.stock) {
                    existing.qty++;
                }
            } else {
                cart.push({ ...product, qty: 1 });
            }
            updateCartBadge();
            
            const cartBtn = document.getElementById('cartFloat');
            cartBtn.style.transform = 'scale(1.1)';
            setTimeout(() => cartBtn.style.transform = 'scale(1)', 200);
        }

        function updateCartBadge() {
            const total = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cartBadge').textContent = total;
        }

        function openCart() {
            if (cart.length === 0) {
                document.getElementById('cartBody').innerHTML = '<div class="empty-state"><div class="empty-icon">üõí</div><div>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div></div>';
            } else {
                renderCart();
            }
            document.getElementById('cartModal').classList.add('show');
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('show');
        }

        function renderCart() {
            const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
            
            document.getElementById('cartBody').innerHTML = `
                ${cart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-icon">${item.icon}</div>
                        <div class="cart-item-info">
                            <div class="cart-item-title">${item.title}</div>
                            <div class="cart-item-price">M$ ${fmt(item.price)} √ó ${item.qty} = M$ ${fmt(item.price * item.qty)}</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="qty-btn" onclick="changeQty(${item.id}, -1)">‚àí</button>
                            <div class="qty-value">${item.qty}</div>
                            <button class="qty-btn" onclick="changeQty(${item.id}, 1)">+</button>
                        </div>
                    </div>
                `).join('')}
                
                <div class="cart-total">
                    <div class="total-row">
                        <div class="total-label">–ò—Ç–æ–≥–æ:</div>
                        <div class="total-value">M$ ${fmt(total)}</div>
                    </div>
                    <div class="total-row">
                        <div class="total-label">–ë–∞–ª–∞–Ω—Å:</div>
                        <div style="color: ${currentUser.balance >= total ? 'var(--good)' : 'var(--danger)'}">M$ ${fmt(currentUser.balance)}</div>
                    </div>
                </div>

                <div class="swipe-confirm">
                    <div class="swipe-label">–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –≤–ø—Ä–∞–≤–æ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞</div>
                    <div class="swipe-track" id="swipeTrack">
                        <div class="swipe-hint" id="swipeHint">–û–ø–ª–∞—Ç–∏—Ç—å M$ ${fmt(total)}</div>
                        <div class="swipe-knob" id="swipeKnob">‚ûú</div>
                    </div>
                </div>
            `;

            initSwipe(total);
        }

        function changeQty(productId, delta) {
            const item = cart.find(i => i.id === productId);
            if (!item) return;

            const products = getProducts();
            const product = products.find(p => p.id === productId);
            item.qty += delta;

            if (item.qty <= 0) {
                cart = cart.filter(i => i.id !== productId);
            } else if (item.qty > product.stock) {
                item.qty = product.stock;
            }

            updateCartBadge();
            renderCart();
        }

        function initSwipe(total) {
            const track = document.getElementById('swipeTrack');
            const knob = document.getElementById('swipeKnob');
            const hint = document.getElementById('swipeHint');
            
            if (!track || !knob) return;

            let dragging = false;
            let startX = 0;
            let startTranslate = 0;
            let currentX = 0;

            const maxTranslate = () => track.clientWidth - knob.clientWidth - 8;

            const setTranslate = (x) => {
                currentX = Math.max(0, Math.min(x, maxTranslate()));
                knob.style.transform = `translateX(${currentX}px)`;
                const progress = maxTranslate() > 0 ? currentX / maxTranslate() : 0;
                hint.style.opacity = Math.max(0, 1 - progress * 1.5);
            };

            const reset = () => {
                dragging = false;
                knob.style.transform = 'translateX(0)';
                currentX = 0;
                hint.style.opacity = 1;
            };

            const checkout = () => {
                if (total > currentUser.balance) {
                    showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'error');
                    reset();
                    return;
                }

                knob.classList.add('success');
                knob.textContent = '‚úì';

                setTimeout(() => {
                    // Process purchase
                    let products = getProducts();
                    let stores = getStores();
                    
                    cart.forEach(item => {
                        const product = products.find(p => p.id === item.id);
                        if (product) {
                            product.stock -= item.qty;
                            product.soldCount = (product.soldCount || 0) + item.qty;
                            
                            // Add revenue to store
                            if (product.storeId) {
                                const store = stores.find(s => s.id === product.storeId);
                                if (store) {
                                    const itemRevenue = product.price * item.qty;
                                    store.revenue = (store.revenue || 0) + itemRevenue;
                                    store.withdrawalBalance = (store.withdrawalBalance || 0) + itemRevenue;
                                    store.soldCount = (store.soldCount || 0) + item.qty;
                                }
                            }
                        }
                    });

                    saveProducts(products);
                    saveStores(stores);

                    // Update user balance
                    currentUser.balance -= total;
                    let users = getUsers();
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    users[userIndex] = currentUser;
                    saveUsers(users);
                    localStorage.setItem(LS_SESSION, JSON.stringify(currentUser));

                    // Show success
                    document.getElementById('cartBody').innerHTML = `
                        <div class="success-screen">
                            <svg class="success-icon" viewBox="0 0 100 100">
                                <circle class="success-circle" cx="50" cy="50" r="45" />
                                <path class="success-check" d="M30 52 L43 65 L70 35" />
                            </svg>
                            <h2>–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</h2>
                            <p style="color: var(--muted); margin-top: 8px;">–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É</p>
                            <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeCart()">–ì–æ—Ç–æ–≤–æ</button>
                        </div>
                    `;

                    cart = [];
                    updateCartBadge();
                    updateUI();
                }, 300);
            };

            knob.addEventListener('pointerdown', (e) => {
                dragging = true;
                startX = e.clientX;
                startTranslate = currentX;
                knob.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('pointermove', (e) => {
                if (!dragging) return;
                const deltaX = e.clientX - startX;
                setTranslate(startTranslate + deltaX);
            });

            document.addEventListener('pointerup', () => {
                if (!dragging) return;
                dragging = false;
                knob.style.cursor = 'grab';
                
                const progress = maxTranslate() > 0 ? currentX / maxTranslate() : 0;
                if (progress > 0.85) {
                    checkout();
                } else {
                    reset();
                }
            });
        }

        // My Store
        function renderMyStore() {
            const stores = getStores();
            const myStore = stores.find(s => s.ownerId === currentUser.id);

            if (!myStore) {
                document.getElementById('noStoreContent').classList.remove('hidden');
                document.getElementById('hasStoreContent').classList.add('hidden');
            } else {
                document.getElementById('noStoreContent').classList.add('hidden');
                document.getElementById('hasStoreContent').classList.remove('hidden');
                
                document.getElementById('storeName').textContent = myStore.name || '–ú–æ–π –º–∞–≥–∞–∑–∏–Ω';
                
                const products = getProducts().filter(p => p.storeId === myStore.id);
                document.getElementById('storeProductCount').textContent = products.length;
                document.getElementById('storeSales').textContent = myStore.soldCount || 0;
                
                // Update revenue display with withdrawal button
                const withdrawalBalance = myStore.withdrawalBalance || 0;
                const revenueText = `M$ ${fmt(myStore.revenue || 0)}`;
                document.getElementById('storeRevenue').innerHTML = `
                    ${revenueText}
                    ${withdrawalBalance > 0 ? `<br><button class="btn btn-small" style="margin-top: 8px;" onclick="withdrawProfit()">–í—ã–≤–µ—Å—Ç–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å</button>` : ''}
                `;

                const grid = document.getElementById('myProducts');
                if (products.length === 0) {
                    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><div>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div></div>';
                } else {
                    grid.innerHTML = products.map(p => `
                        <div class="product-card">
                            <div class="product-image">${p.icon}</div>
                            <div class="product-info">
                                <div class="product-title">${p.title}</div>
                                <div class="product-description">${p.description}</div>
                                <div class="product-footer">
                                    <div class="product-price">M$ ${fmt(p.price)}</div>
                                    <div class="stock-badge">–û—Å—Ç–∞–ª–æ—Å—å: ${p.stock}</div>
                                </div>
                                <div style="margin-top: 12px; display: flex; gap: 8px;">
                                    <button class="btn btn-secondary btn-small" onclick="editProduct(${p.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteProduct(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // Withdrawal system
        function withdrawProfit() {
            const stores = getStores();
            const myStore = stores.find(s => s.ownerId === currentUser.id);
            if (!myStore) return;

            const amount = myStore.withdrawalBalance || myStore.revenue || 0;
            if (amount <= 0) {
                showNotification('–ù–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞', 'error');
                return;
            }

            // Create withdrawal request
            const withdrawals = getWithdrawals();
            const requestId = Date.now();
            withdrawals.push({
                id: requestId,
                storeId: myStore.id,
                ownerId: currentUser.id,
                ownerName: currentUser.username,
                storeName: myStore.name,
                amount: amount,
                status: 'pending',
                requestedAt: new Date().toISOString(),
                scheduledAt: new Date(Date.now() + WITHDRAWAL_DELAY).toISOString()
            });
            saveWithdrawals(withdrawals);

            // Reset withdrawal balance
            myStore.revenue = 0;
            myStore.withdrawalBalance = 0;
            stores[stores.findIndex(s => s.id === myStore.id)] = myStore;
            saveStores(stores);

            showNotification('–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –î–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø—è—Ç –Ω–∞ –±–∞–ª–∞–Ω—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'info');
            renderMyStore();
        }

        function buyStore() {
            const bankBalance = getBankBalance();
            if (bankBalance < STORE_PRICE) {
                showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –ù—É–∂–Ω–æ M$ ${fmt(STORE_PRICE)} (–≤–∞—à –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –±–∞–ª–∞–Ω—Å: M$ ${fmt(bankBalance)})`, 'error');
                return;
            }

            // Create modal to show store info with name input
            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <h2 style="margin-bottom: 20px;">–ü–æ–∫—É–ø–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞</h2>
                    <div class="form-group" style="text-align: left;">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</label>
                        <input type="text" id="storeNameInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞" value="–ú–∞–≥–∞–∑–∏–Ω ${currentUser.username}">
                    </div>
                    <div class="store-info-box">
                        <div class="store-info-row">
                            <span class="store-info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                            <span class="store-info-value" style="color: var(--accent);">M$ ${fmt(STORE_PRICE)}</span>
                        </div>
                        <div class="store-info-row">
                            <span class="store-info-label">–í–∞—à –±–∞–ª–∞–Ω—Å –≤ –±–∞–Ω–∫–µ</span>
                            <span class="store-info-value" style="color: var(--good);">M$ ${fmt(bankBalance)}</span>
                        </div>
                        <div class="store-info-row">
                            <span class="store-info-label">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–æ—Ö–æ–¥</span>
                            <span class="store-info-value" style="color: var(--good);">+M$ ${fmt(DAILY_INCOME)}</span>
                        </div>
                        <div class="store-info-row">
                            <span class="store-info-label">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –Ω–∞–ª–æ–≥</span>
                            <span class="store-info-value" style="color: var(--danger);">-M$ ${fmt(DAILY_TAX)}</span>
                        </div>
                        <div class="store-info-row" style="border-top: 1px solid var(--stroke); padding-top: 12px; margin-top: 12px;">
                            <span class="store-info-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –≤ –¥–µ–Ω—å</span>
                            <span class="store-info-value" style="color: var(--good); font-size: 18px;">M$ ${fmt(DAILY_INCOME - DAILY_TAX)}</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="confirmBuyStore()" style="margin-top: 20px;">–ö—É–ø–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
                    <button class="btn btn-secondary" onclick="closeStoreInfoModal()" style="margin-top: 12px;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop show';
            modal.id = 'storeInfoModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-body">${modalContent}</div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeStoreInfoModal() {
            const modal = document.getElementById('storeInfoModal');
            if (modal) modal.remove();
        }

        function confirmBuyStore() {
            const storeName = document.getElementById('storeNameInput').value.trim();
            if (!storeName) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞', 'error');
                return;
            }

            // Deduct from bank balance
            if (!updateBankBalance(-STORE_PRICE)) {
                showNotification('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑ –±–∞–Ω–∫–∞', 'error');
                return;
            }

            const stores = getStores();
            const newStore = {
                id: Date.now(),
                ownerId: currentUser.id,
                name: storeName,
                soldCount: 0,
                revenue: 0,
                withdrawalBalance: 0
            };
            stores.push(newStore);
            saveStores(stores);

            currentUser.role = 'shop_owner';
            
            let users = getUsers();
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            users[userIndex] = currentUser;
            saveUsers(users);
            localStorage.setItem(LS_SESSION, JSON.stringify(currentUser));

            closeStoreInfoModal();
            showNotification('–ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
            updateUI();
            renderMyStore();
        }

        function showAddProductModal() {
            document.getElementById('addProductModal').classList.add('show');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('show');
        }

        function addProduct() {
            const stores = getStores();
            const myStore = stores.find(s => s.ownerId === currentUser.id);
            if (!myStore) return;

            const title = document.getElementById('productTitle').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const icon = document.getElementById('productIcon').value.trim() || 'üì¶';
            const category = document.getElementById('productCategory').value;

            if (!title || price <= 0 || stock < 0) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'error');
                return;
            }

            // Calculate listing fee (10% of price)
            const listingFee = Math.round(price * (LISTING_FEE_PERCENT / 100));
            
            if (currentUser.balance < listingFee) {
                showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏! –ù—É–∂–Ω–æ M$ ${fmt(listingFee)} (${LISTING_FEE_PERCENT}% –æ—Ç —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞)`, 'error');
                return;
            }

            // Deduct listing fee
            currentUser.balance -= listingFee;
            let users = getUsers();
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            users[userIndex] = currentUser;
            saveUsers(users);
            localStorage.setItem(LS_SESSION, JSON.stringify(currentUser));

            const products = getProducts();
            const newProduct = {
                id: Date.now(),
                storeId: myStore.id,
                title,
                description: desc,
                price,
                stock,
                icon,
                category,
                soldCount: 0
            };

            products.push(newProduct);
            saveProducts(products);

            closeAddProductModal();
            renderMyStore();
            updateUI();
            showNotification(`–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω! –ö–æ–º–∏—Å—Å–∏—è –∑–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ: M$ ${fmt(listingFee)} (${LISTING_FEE_PERCENT}%)`, 'success');
        }

        function editProduct(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                showNotification('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            const modalContent = `
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="editProductTitle" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" value="${product.title}">
                </div>
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" id="editProductDesc" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" value="${product.description}">
                </div>
                <div class="form-group">
                    <label class="form-label">–¶–µ–Ω–∞ (M$)</label>
                    <input type="number" id="editProductPrice" class="form-input" placeholder="1000" value="${product.price}">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="editProductStock" class="form-input" placeholder="10" value="${product.stock}">
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label>
                    <input type="text" id="editProductIcon" class="form-input" placeholder="üì¶" maxlength="2" value="${product.icon}">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="editProductCategory" class="form-input">
                        <option value="electronics" ${product.category === 'electronics' ? 'selected' : ''}>–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                        <option value="clothing" ${product.category === 'clothing' ? 'selected' : ''}>–û–¥–µ–∂–¥–∞</option>
                        <option value="home" ${product.category === 'home' ? 'selected' : ''}>–î–æ–º</option>
                        <option value="sport" ${product.category === 'sport' ? 'selected' : ''}>–°–ø–æ—Ä—Ç</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="saveEditedProduct(${productId})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            `;

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop show';
            modal.id = 'editProductModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</div>
                        <button class="close-btn" onclick="closeEditProductModal()">√ó</button>
                    </div>
                    <div class="modal-body">${modalContent}</div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeEditProductModal() {
            const modal = document.getElementById('editProductModal');
            if (modal) modal.remove();
        }

        function saveEditedProduct(productId) {
            const title = document.getElementById('editProductTitle').value.trim();
            const desc = document.getElementById('editProductDesc').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value) || 0;
            const stock = parseInt(document.getElementById('editProductStock').value) || 0;
            const icon = document.getElementById('editProductIcon').value.trim() || 'üì¶';
            const category = document.getElementById('editProductCategory').value;

            if (!title || price <= 0 || stock < 0) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'error');
                return;
            }

            let products = getProducts();
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex === -1) {
                showNotification('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            products[productIndex] = {
                ...products[productIndex],
                title,
                description: desc,
                price,
                stock,
                icon,
                category
            };

            saveProducts(products);
            closeEditProductModal();
            renderMyStore();
            showNotification('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
        }

        function deleteProduct(productId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) {
                let products = getProducts();
                products = products.filter(p => p.id !== productId);
                saveProducts(products);
                renderMyStore();
            }
        }

        // Admin
        function renderAdmin() {
            const stores = getStores();
            const products = getProducts();
            const users = getUsers();

            document.getElementById('adminStoresCount').textContent = stores.length;
            document.getElementById('adminProductsCount').textContent = products.length;
            document.getElementById('adminUsersCount').textContent = users.length;

            // Render withdrawal requests
            renderAdminWithdrawals();

            const tbody = document.getElementById('adminStoresTable');
            tbody.innerHTML = stores.map(store => {
                const owner = users.find(u => u.id === store.ownerId);
                const storeProducts = products.filter(p => p.storeId === store.id);
                return `
                    <tr>
                        <td>${owner ? owner.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</td>
                        <td>${store.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
                        <td>${storeProducts.length}</td>
                        <td>${store.soldCount || 0}</td>
                        <td style="color: var(--good);">M$ ${fmt(store.revenue || 0)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderAdminWithdrawals() {
            const withdrawals = getWithdrawals().filter(w => w.status === 'pending');
            const container = document.getElementById('adminWithdrawals');
            
            if (withdrawals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úì</div><div>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</div></div>';
                return;
            }

            container.innerHTML = withdrawals.map(w => {
                const canApprove = new Date(w.scheduledAt) <= new Date();
                return `
                    <div class="list-item" style="flex-direction: column; align-items: stretch; gap: 12px; padding: 16px; background: var(--panel-2); border: 1px solid var(--stroke); border-radius: 14px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${w.storeName}</strong> (${w.ownerName})
                                <div style="color: var(--muted); font-size: 13px;">
                                    –°—É–º–º–∞: <strong style="color: var(--good);">M$ ${fmt(w.amount)}</strong>
                                </div>
                                <div style="color: var(--muted); font-size: 12px;">
                                    –ó–∞–ø—Ä–æ—à–µ–Ω–æ: ${new Date(w.requestedAt).toLocaleString('ru-RU')}
                                </div>
                                ${!canApprove ? `<div style="color: var(--amber); font-size: 12px;">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è: ${new Date(w.scheduledAt).toLocaleString('ru-RU')}</div>` : ''}
                            </div>
                            <button class="btn btn-small ${canApprove ? '' : 'btn-secondary'}"
                                    onclick="approveWithdrawal(${w.id})"
                                    ${canApprove ? '' : 'disabled'}>
                                ${canApprove ? '–°–¥–µ–ª–∞–Ω–æ ‚úì' : '–û–∂–∏–¥–∞–Ω–∏–µ...'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function approveWithdrawal(requestId) {
            const withdrawals = getWithdrawals();
            const request = withdrawals.find(w => w.id === requestId);
            
            if (!request || request.status !== 'pending') {
                showNotification('–ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω', 'error');
                return;
            }

            // Update bank balance for the owner
            try {
                const users = JSON.parse(localStorage.getItem('msbank_users_v11') || '[]');
                const userIndex = users.findIndex(u => u.username === request.ownerName);
                
                if (userIndex === -1) {
                    // Create bank account if doesn't exist
                    users.push({
                        username: request.ownerName,
                        password: '12345',
                        isAdmin: false,
                        balance: request.amount,
                        online: false,
                        deleted: false
                    });
                } else {
                    users[userIndex].balance = Math.round((users[userIndex].balance + request.amount) * 100) / 100;
                }
                
                localStorage.setItem('msbank_users_v11', JSON.stringify(users));
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤', 'error');
                return;
            }

            // Mark as completed
            request.status = 'approved';
            request.approvedAt = new Date().toISOString();
            saveWithdrawals(withdrawals);

            showNotification(`–í—ã–≤–æ–¥ –Ω–∞ —Å—É–º–º—É M$ ${fmt(request.amount)} –æ–¥–æ–±—Ä–µ–Ω –¥–ª—è ${request.ownerName}`, 'success');
            
            // Notify user (store notification in localStorage)
            notifyStoreOwner(request.ownerId, `–î–µ–Ω—å–≥–∏ –≤ —Ä–∞–∑–º–µ—Ä–µ M$ ${fmt(request.amount)} –ø–æ—Å—Ç—É–ø–∏–ª–∏ –Ω–∞ –≤–∞—à –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –±–∞–ª–∞–Ω—Å`);
            
            renderAdmin();
        }

        function notifyStoreOwner(ownerId, message) {
            // Create a simple notification system
            const notifications = JSON.parse(localStorage.getItem('mtshop_notifications') || '{}');
            if (!notifications[ownerId]) {
                notifications[ownerId] = [];
            }
            notifications[ownerId].push({
                id: Date.now(),
                message: message,
                timestamp: new Date().toISOString(),
                read: false
            });
            localStorage.setItem('mtshop_notifications', JSON.stringify(notifications));
        }

        // Check for user notifications
        function checkUserNotifications() {
            if (!currentUser) return;
            
            const notifications = JSON.parse(localStorage.getItem('mtshop_notifications') || '{}');
            const userNotifications = notifications[currentUser.id] || [];
            const unread = userNotifications.filter(n => !n.read);
            
            unread.forEach(notif => {
                showNotification(notif.message, 'success');
                notif.read = true;
            });
            
            if (unread.length > 0) {
                localStorage.setItem('mtshop_notifications', JSON.stringify(notifications));
            }
        }

        // Change password
        function openChangePassword() {
            const modalContent = `
                <div class="form-group">
                    <label class="form-label">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="oldPassword" class="form-input" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            `;

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop show';
            modal.id = 'changePasswordModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</div>
                        <button class="close-btn" onclick="closeChangePasswordModal()">√ó</button>
                    </div>
                    <div class="modal-body">${modalContent}</div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) modal.remove();
        }

        function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }

            if (newPassword.length < 3) {
                showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞', 'error');
                return;
            }

            let users = getUsers();
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            
            if (userIndex === -1) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            if (users[userIndex].password !== oldPassword) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            users[userIndex].password = newPassword;
            saveUsers(users);
            
            currentUser = users[userIndex];
            localStorage.setItem(LS_SESSION, JSON.stringify(currentUser));

            closeChangePasswordModal();
            showNotification('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω', 'success');
        }

        // Init
        seedData();
        
        // Try Telegram auto-login first
        if (tgUser) {
            tryTelegramAutoLogin();
        } else {
            const session = localStorage.getItem(LS_SESSION);
            if (session) {
                const sessionUser = JSON.parse(session);
                const users = getUsers();
                currentUser = users.find(u => u.id === sessionUser.id);
                if (currentUser) {
                    showMainApp();
                }
            }
        }
    </script>
</body>
</html>